<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Fuel Verification System</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c12;
    --panel: #0d1420;
    --panel2: #111b2e;
    --border: #1a2d4a;
    --accent: #00d4ff;
    --accent2: #00ff88;
    --warn: #ff9500;
    --danger: #ff3b5c;
    --text: #c8dff5;
    --muted: #4a6785;
    --glow: 0 0 20px rgba(0,212,255,0.3);
    --glow2: 0 0 20px rgba(0,255,136,0.3);
    --glow-danger: 0 0 20px rgba(255,59,92,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Exo 2', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { position: relative; z-index: 1; max-width: 1300px; margin: 0 auto; padding: 20px; }

  /* Header */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 0 30px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 28px;
  }
  .logo { display: flex; align-items: center; gap: 14px; }
  .logo-icon {
    width: 48px; height: 48px;
    background: linear-gradient(135deg, #00d4ff, #0066cc);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    box-shadow: var(--glow);
    animation: pulse-icon 3s ease-in-out infinite;
  }
  @keyframes pulse-icon {
    0%,100% { box-shadow: 0 0 20px rgba(0,212,255,0.3); }
    50% { box-shadow: 0 0 40px rgba(0,212,255,0.6); }
  }
  .logo-text h1 { font-family: 'Rajdhani', sans-serif; font-size: 22px; font-weight: 700; color: #fff; letter-spacing: 1px; }
  .logo-text p { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }
  
  .header-right { display: flex; align-items: center; gap: 16px; }
  .status-badge {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 16px; border-radius: 20px;
    background: var(--panel2); border: 1px solid var(--border);
    font-size: 12px; font-weight: 600; letter-spacing: 1px;
  }
  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent2);
    animation: blink 1.5s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

  /* Main grid */
  .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .grid-2 { display: grid; grid-template-columns: 1.4fr 1fr; gap: 20px; margin-bottom: 20px; }
  .grid-full { margin-bottom: 20px; }

  /* Panel */
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 22px;
    position: relative;
    overflow: hidden;
  }
  .panel::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.5;
  }
  .panel.green::before { background: linear-gradient(90deg, transparent, var(--accent2), transparent); }
  .panel.warn::before { background: linear-gradient(90deg, transparent, var(--warn), transparent); }
  .panel.danger::before { background: linear-gradient(90deg, transparent, var(--danger), transparent); }

  .panel-label {
    font-size: 10px; letter-spacing: 3px; text-transform: uppercase;
    color: var(--muted); margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
  }
  .panel-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* Big metric */
  .big-metric { font-family: 'Share Tech Mono', monospace; font-size: 42px; color: #fff; line-height: 1; }
  .big-metric span { font-size: 16px; color: var(--muted); margin-left: 4px; }
  .metric-sub { font-size: 12px; color: var(--muted); margin-top: 8px; }

  /* Flow gauge */
  .gauge-wrap { display: flex; justify-content: center; padding: 10px 0; }
  .gauge {
    position: relative; width: 160px; height: 160px;
  }
  .gauge svg { width: 100%; height: 100%; transform: rotate(-90deg); }
  .gauge-track { fill: none; stroke: var(--border); stroke-width: 10; }
  .gauge-fill {
    fill: none; stroke: var(--accent); stroke-width: 10;
    stroke-linecap: round;
    stroke-dasharray: 408;
    stroke-dashoffset: 408;
    transition: stroke-dashoffset 0.5s ease;
    filter: drop-shadow(0 0 6px rgba(0,212,255,0.8));
  }
  .gauge-center {
    position: absolute; inset: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .gauge-val { font-family: 'Share Tech Mono', monospace; font-size: 26px; color: #fff; }
  .gauge-unit { font-size: 11px; color: var(--muted); }

  /* Waveform / live chart */
  .chart-wrap { width: 100%; height: 80px; position: relative; }
  canvas.wave { width: 100%; height: 100%; }

  /* Comparison meter */
  .compare-wrap { margin-top: 16px; }
  .compare-bar-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
  .compare-label { font-size: 11px; width: 80px; color: var(--muted); }
  .compare-track { flex: 1; height: 10px; background: var(--panel2); border-radius: 5px; overflow: hidden; }
  .compare-fill { height: 100%; border-radius: 5px; transition: width 0.5s ease; }
  .fill-meter { background: linear-gradient(90deg, #0066cc, #00d4ff); }
  .fill-sensor { background: linear-gradient(90deg, #006644, #00ff88); }
  .compare-val { font-family: 'Share Tech Mono', monospace; font-size: 13px; width: 60px; text-align: right; }

  .diff-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-top: 16px; padding: 12px 16px; border-radius: 10px;
    background: var(--panel2); border: 1px solid var(--border);
    transition: all 0.4s;
  }
  .diff-row.safe { border-color: rgba(0,255,136,0.3); background: rgba(0,255,136,0.05); }
  .diff-row.unsafe { border-color: rgba(255,59,92,0.4); background: rgba(255,59,92,0.08); animation: shake 0.4s ease; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
  .diff-label { font-size: 12px; color: var(--muted); }
  .diff-val { font-family: 'Share Tech Mono', monospace; font-size: 18px; }

  /* Buttons */
  .btn {
    padding: 11px 22px; border-radius: 10px; border: none; cursor: pointer;
    font-family: 'Exo 2', sans-serif; font-weight: 600; font-size: 13px;
    letter-spacing: 1px; transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 8px;
  }
  .btn-primary { background: linear-gradient(135deg, #0066cc, #00d4ff); color: #fff; }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,212,255,0.3); }
  .btn-green { background: linear-gradient(135deg, #006644, #00ff88); color: #001a0d; }
  .btn-green:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,255,136,0.3); }
  .btn-danger { background: linear-gradient(135deg, #cc0033, #ff3b5c); color: #fff; }
  .btn-outline {
    background: transparent; border: 1px solid var(--border); color: var(--muted);
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

  /* Input */
  .input-wrap { margin-bottom: 14px; }
  .input-wrap label { display: block; font-size: 11px; letter-spacing: 2px; color: var(--muted); margin-bottom: 7px; text-transform: uppercase; }
  .input-wrap input {
    width: 100%; padding: 12px 16px; background: var(--panel2); border: 1px solid var(--border);
    border-radius: 10px; color: #fff; font-family: 'Share Tech Mono', monospace; font-size: 16px;
    outline: none; transition: border-color 0.2s;
  }
  .input-wrap input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,212,255,0.1); }

  /* Control buttons row */
  .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 4px; }

  /* Alert banner */
  .alert-banner {
    padding: 14px 20px; border-radius: 12px; margin-bottom: 20px;
    display: none; align-items: center; gap: 14px;
    animation: slide-in 0.4s ease;
  }
  .alert-banner.show { display: flex; }
  .alert-banner.fraud {
    background: rgba(255,59,92,0.12); border: 1px solid rgba(255,59,92,0.4);
  }
  .alert-banner.ok {
    background: rgba(0,255,136,0.08); border: 1px solid rgba(0,255,136,0.3);
  }
  @keyframes slide-in { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:none} }
  .alert-icon { font-size: 28px; }
  .alert-text h3 { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
  .alert-text p { font-size: 12px; color: var(--muted); }

  /* Session log */
  .log-table { width: 100%; border-collapse: collapse; }
  .log-table th {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--muted); padding: 8px 12px; text-align: left;
    border-bottom: 1px solid var(--border);
  }
  .log-table td { padding: 12px 12px; font-size: 13px; border-bottom: 1px solid rgba(26,45,74,0.5); }
  .log-table tr:hover td { background: rgba(0,212,255,0.03); }
  .badge {
    display: inline-block; padding: 3px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 600; letter-spacing: 1px;
  }
  .badge-ok { background: rgba(0,255,136,0.15); color: var(--accent2); border: 1px solid rgba(0,255,136,0.3); }
  .badge-fraud { background: rgba(255,59,92,0.15); color: var(--danger); border: 1px solid rgba(255,59,92,0.3); }
  .badge-warn { background: rgba(255,149,0,0.15); color: var(--warn); border: 1px solid rgba(255,149,0,0.3); }
  .mono { font-family: 'Share Tech Mono', monospace; }

  /* Receipt modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
    z-index: 1000; display: none; align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .receipt {
    background: var(--panel); border: 1px solid var(--border); border-radius: 20px;
    padding: 32px; width: 380px; position: relative;
    animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  @keyframes pop-in { from{opacity:0;transform:scale(0.85)} to{opacity:1;transform:none} }
  .receipt-header { text-align: center; margin-bottom: 24px; }
  .receipt-logo { font-size: 36px; margin-bottom: 8px; }
  .receipt h2 { font-family: 'Rajdhani', sans-serif; font-size: 20px; font-weight: 700; }
  .receipt-divider { border: none; border-top: 1px dashed var(--border); margin: 16px 0; }
  .receipt-row { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
  .receipt-row .key { font-size: 12px; color: var(--muted); }
  .receipt-row .val { font-family: 'Share Tech Mono', monospace; font-size: 14px; }
  .receipt-total { font-size: 22px; color: var(--accent2); }
  .receipt-qr {
    width: 80px; height: 80px; background: var(--panel2); border: 1px solid var(--border);
    border-radius: 8px; margin: 16px auto; display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--muted); text-align: center;
  }
  .receipt-footer { text-align: center; font-size: 10px; color: var(--muted); margin-top: 16px; }
  .close-btn {
    position: absolute; top: 14px; right: 14px;
    background: var(--panel2); border: 1px solid var(--border); color: var(--muted);
    width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
  }

  /* Pump selector */
  .pump-selector { display: flex; gap: 10px; margin-bottom: 16px; }
  .pump-btn {
    flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--panel2); color: var(--muted); cursor: pointer;
    font-family: 'Exo 2', sans-serif; font-size: 12px; font-weight: 600; text-align: center;
    transition: all 0.2s;
  }
  .pump-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,212,255,0.08); }

  /* Fuel type indicator */
  .fuel-type-row { display: flex; gap: 8px; margin-bottom: 16px; }
  .fuel-chip {
    padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 600;
    border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;
    color: var(--muted);
  }
  .fuel-chip.active { border-color: var(--warn); color: var(--warn); background: rgba(255,149,0,0.1); }

  /* Stats row */
  .stats-mini { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; }
  .stat-mini { background: var(--panel2); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); }
  .stat-mini .val { font-family: 'Share Tech Mono', monospace; font-size: 20px; color: #fff; }
  .stat-mini .lbl { font-size: 10px; color: var(--muted); margin-top: 4px; letter-spacing: 1px; text-transform: uppercase; }

  /* Scroll for log */
  .log-scroll { max-height: 280px; overflow-y: auto; }
  .log-scroll::-webkit-scrollbar { width: 4px; }
  .log-scroll::-webkit-scrollbar-track { background: transparent; }
  .log-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Scan animation on active */
  @keyframes scan {
    0% { top: 0; opacity: 0.6; }
    100% { top: 100%; opacity: 0; }
  }
  .scanning::after {
    content: '';
    position: absolute; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scan 1s linear infinite;
    top: 0;
  }

  .session-active .panel { border-color: rgba(0,212,255,0.2); }

  @media(max-width: 900px) {
    .grid { grid-template-columns: 1fr 1fr; }
    .grid-2 { grid-template-columns: 1fr; }
  }
  @media(max-width: 600px) {
    .grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <div class="logo">
      <div class="logo-icon">â›½</div>
      <div class="logo-text">
        <h1>FUEL VERIFY PRO</h1>
        <p>IoT Fraud Detection System</p>
      </div>
    </div>
    <div class="header-right">
      <div class="status-badge">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">SENSOR READY</span>
      </div>
    </div>
  </header>

  <!-- Alert Banner -->
  <div class="alert-banner" id="alertBanner">
    <div class="alert-icon" id="alertIcon">âš ï¸</div>
    <div class="alert-text">
      <h3 id="alertTitle">Alert</h3>
      <p id="alertMsg">â€”</p>
    </div>
  </div>

  <!-- Top stats -->
  <div class="grid">
    <!-- Flow Gauge -->
    <div class="panel">
      <div class="panel-label">Live Flow Rate</div>
      <div class="gauge-wrap">
        <div class="gauge" id="gaugeEl">
          <svg viewBox="0 0 160 160">
            <circle class="gauge-track" cx="80" cy="80" r="65"/>
            <circle class="gauge-fill" id="gaugeFill" cx="80" cy="80" r="65"/>
          </svg>
          <div class="gauge-center">
            <div class="gauge-val" id="flowRateVal">0.00</div>
            <div class="gauge-unit">L / min</div>
          </div>
        </div>
      </div>
      <div class="chart-wrap"><canvas class="wave" id="waveCanvas"></canvas></div>
    </div>

    <!-- Sensor Total -->
    <div class="panel green">
      <div class="panel-label">Sensor Reading</div>
      <div class="big-metric" id="sensorTotal">0.000<span>L</span></div>
      <div class="metric-sub" id="sensorSub">No active session</div>
      <hr style="border:none;border-top:1px solid var(--border);margin:20px 0;">
      <div class="panel-label">Pump Meter Input</div>
      <div class="big-metric" id="meterDisplay" style="color:var(--accent)">â€”<span>L</span></div>
      <div class="metric-sub">Entered by operator</div>
    </div>

    <!-- Difference -->
    <div class="panel" id="diffPanel">
      <div class="panel-label">Verification Status</div>
      <div style="text-align:center;padding:10px 0">
        <div style="font-size:56px;margin-bottom:8px" id="statusEmoji">ğŸ”µ</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:28px;color:#fff" id="diffVal">â€”</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px">Difference (L)</div>
        <div style="margin-top:16px;padding:10px;background:var(--panel2);border-radius:10px;font-size:12px;color:var(--muted)" id="statusMsg">Start a session to begin verification</div>
      </div>
      <div class="stats-mini" style="margin-top:14px">
        <div class="stat-mini"><div class="val" id="statTotal">0</div><div class="lbl">Sessions</div></div>
        <div class="stat-mini"><div class="val" id="statFraud" style="color:var(--danger)">0</div><div class="lbl">Fraud</div></div>
        <div class="stat-mini"><div class="val" id="statOk" style="color:var(--accent2)">0</div><div class="lbl">Verified</div></div>
      </div>
    </div>
  </div>

  <!-- Middle section -->
  <div class="grid-2">
    <!-- Control Panel -->
    <div class="panel">
      <div class="panel-label">Refueling Session Control</div>

      <div class="pump-selector">
        <div class="pump-btn active" onclick="selectPump(this,'Pump 1')">â›½ Pump 1</div>
        <div class="pump-btn" onclick="selectPump(this,'Pump 2')">â›½ Pump 2</div>
        <div class="pump-btn" onclick="selectPump(this,'Pump 3')">â›½ Pump 3</div>
        <div class="pump-btn" onclick="selectPump(this,'Pump 4')">â›½ Pump 4</div>
      </div>

      <div class="fuel-type-row">
        <div class="fuel-chip active" onclick="selectFuel(this,'Petrol')">ğŸ”´ Petrol</div>
        <div class="fuel-chip" onclick="selectFuel(this,'Diesel')">ğŸŸ¡ Diesel</div>
        <div class="fuel-chip" onclick="selectFuel(this,'Premium')">ğŸ”µ Premium</div>
      </div>

      <div class="input-wrap">
        <label>Vehicle Number</label>
        <input type="text" id="vehicleInput" placeholder="e.g. UP80 AB 1234" value="UP80 AB 1234">
      </div>

      <div class="input-wrap">
        <label>Pump Meter Reading (Litres)</label>
        <input type="number" id="meterInput" placeholder="e.g. 10.00" step="0.001">
      </div>

      <!-- Simulate fraud toggle -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:12px;background:var(--panel2);border-radius:10px;border:1px solid var(--border);">
        <label style="font-size:12px;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="fraudToggle" style="accent-color:var(--danger);width:16px;height:16px;">
          <span>Simulate Meter Tampering (for demo)</span>
        </label>
      </div>

      <div class="controls">
        <button class="btn btn-primary" id="startBtn" onclick="startSession()">â–¶ Start Session</button>
        <button class="btn btn-green" id="stopBtn" onclick="stopSession()" disabled>â¹ Stop & Verify</button>
        <button class="btn btn-outline" onclick="resetAll()">â†º Reset</button>
      </div>
    </div>

    <!-- Comparison Bars -->
    <div class="panel">
      <div class="panel-label">Real-Time Comparison</div>
      <div class="compare-wrap">
        <div class="compare-bar-row">
          <div class="compare-label">Meter</div>
          <div class="compare-track"><div class="compare-fill fill-meter" id="barMeter" style="width:0%"></div></div>
          <div class="compare-val mono" id="barMeterVal">0.000</div>
        </div>
        <div class="compare-bar-row">
          <div class="compare-label">Sensor</div>
          <div class="compare-track"><div class="compare-fill fill-sensor" id="barSensor" style="width:0%"></div></div>
          <div class="compare-val mono" id="barSensorVal">0.000</div>
        </div>
      </div>

      <div class="diff-row" id="diffRow">
        <div>
          <div class="diff-label">Absolute Difference</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">Threshold: Â±0.15 L</div>
        </div>
        <div class="diff-val" id="diffRowVal">â€”</div>
      </div>

      <div style="margin-top:20px">
        <div class="panel-label">IoT Data Stream</div>
        <div style="background:var(--panel2);border-radius:10px;padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--accent2);height:120px;overflow-y:auto;line-height:1.7" id="dataStream">
          <div style="color:var(--muted)">Â» Awaiting sensor data...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Session Log -->
  <div class="panel grid-full">
    <div class="panel-label">Session History & Audit Log</div>
    <div class="log-scroll">
      <table class="log-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Vehicle</th>
            <th>Pump</th>
            <th>Fuel</th>
            <th>Meter (L)</th>
            <th>Sensor (L)</th>
            <th>Diff (L)</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="logBody">
          <tr><td colspan="9" style="text-align:center;color:var(--muted);padding:30px">No sessions recorded yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Receipt Modal -->
<div class="modal-overlay" id="receiptModal">
  <div class="receipt">
    <button class="close-btn" onclick="closeReceipt()">Ã—</button>
    <div class="receipt-header">
      <div class="receipt-logo">â›½</div>
      <h2>FUEL VERIFY PRO</h2>
      <div style="font-size:11px;color:var(--muted);letter-spacing:2px;margin-top:4px">DIGITAL RECEIPT</div>
    </div>
    <hr class="receipt-divider">
    <div class="receipt-row"><span class="key">Session ID</span><span class="val" id="rSessionId">â€”</span></div>
    <div class="receipt-row"><span class="key">Date & Time</span><span class="val" id="rTime">â€”</span></div>
    <div class="receipt-row"><span class="key">Vehicle</span><span class="val" id="rVehicle">â€”</span></div>
    <div class="receipt-row"><span class="key">Pump</span><span class="val" id="rPump">â€”</span></div>
    <div class="receipt-row"><span class="key">Fuel Type</span><span class="val" id="rFuel">â€”</span></div>
    <hr class="receipt-divider">
    <div class="receipt-row"><span class="key">Pump Meter</span><span class="val" id="rMeter">â€”</span></div>
    <div class="receipt-row"><span class="key">Sensor Verified</span><span class="val receipt-total" id="rSensor">â€”</span></div>
    <div class="receipt-row"><span class="key">Difference</span><span class="val" id="rDiff">â€”</span></div>
    <hr class="receipt-divider">
    <div class="receipt-row">
      <span class="key">Verification</span>
      <span class="val" id="rStatus">â€”</span>
    </div>
    <div class="receipt-qr">ğŸ”²<br>QR CODE<br>Scan to verify</div>
    <div class="receipt-footer">This receipt is digitally signed and stored on cloud.<br>Session data cannot be altered retroactively.</div>
    <div style="margin-top:16px;display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:1;justify-content:center" onclick="closeReceipt()">âœ“ Done</button>
      <button class="btn btn-outline" style="flex:1;justify-content:center" onclick="printReceipt()">ğŸ–¨ Print</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sessionActive = false;
let sensorLitres = 0;
let flowRate = 0;
let simInterval = null;
let waveInterval = null;
let streamInterval = null;
let selectedPump = 'Pump 1';
let selectedFuel = 'Petrol';
let sessionCount = 0, fraudCount = 0, okCount = 0;
let waveData = Array(80).fill(0);
let sessionLogs = [];
let currentMeterReading = 0;

// â”€â”€ Wave Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const waveCanvas = document.getElementById('waveCanvas');
const ctx = waveCanvas.getContext('2d');
function resizeCanvas() {
  waveCanvas.width = waveCanvas.offsetWidth * devicePixelRatio;
  waveCanvas.height = waveCanvas.offsetHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function drawWave() {
  const w = waveCanvas.offsetWidth, h = waveCanvas.offsetHeight;
  ctx.clearRect(0, 0, w, h);
  
  // Grid lines
  ctx.strokeStyle = 'rgba(26,45,74,0.5)';
  ctx.lineWidth = 0.5;
  for (let i = 0; i < 5; i++) {
    ctx.beginPath();
    ctx.moveTo(0, (h/4)*i);
    ctx.lineTo(w, (h/4)*i);
    ctx.stroke();
  }

  if (waveData.every(v => v === 0)) return;

  // Fill
  const grad = ctx.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, 'rgba(0,212,255,0.3)');
  grad.addColorStop(1, 'rgba(0,212,255,0)');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.moveTo(0, h);
  waveData.forEach((v, i) => {
    const x = (i / (waveData.length - 1)) * w;
    const y = h - (v / 10) * h * 0.9;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.lineTo(w, h); ctx.closePath(); ctx.fill();

  // Line
  ctx.strokeStyle = '#00d4ff';
  ctx.lineWidth = 2;
  ctx.shadowColor = '#00d4ff';
  ctx.shadowBlur = 8;
  ctx.beginPath();
  waveData.forEach((v, i) => {
    const x = (i / (waveData.length - 1)) * w;
    const y = h - (v / 10) * h * 0.9;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
  ctx.shadowBlur = 0;
}
setInterval(drawWave, 50);

// â”€â”€ Gauge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateGauge(rate) {
  const maxRate = 8;
  const fraction = Math.min(rate / maxRate, 1);
  const circumference = 408;
  const offset = circumference * (1 - fraction);
  document.getElementById('gaugeFill').style.strokeDashoffset = offset;
  document.getElementById('flowRateVal').textContent = rate.toFixed(2);
}

// â”€â”€ Session logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startSession() {
  const meterVal = parseFloat(document.getElementById('meterInput').value);
  if (!meterVal || meterVal <= 0) {
    showAlert('warn', 'âš ï¸', 'Input Required', 'Please enter the pump meter reading before starting.');
    return;
  }
  currentMeterReading = meterVal;
  sensorLitres = 0;
  sessionActive = true;

  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  document.getElementById('meterInput').disabled = true;
  document.getElementById('statusText').textContent = 'REFUELING ACTIVE';
  document.getElementById('statusDot').style.background = '#00ff88';
  document.getElementById('sensorSub').textContent = 'Session running...';
  document.getElementById('meterDisplay').textContent = meterVal.toFixed(3);
  hideAlert();

  const isFraud = document.getElementById('fraudToggle').checked;
  // Sensor reads slightly less than meter if fraud
  const targetLitres = isFraud
    ? meterVal * (0.88 + Math.random() * 0.07)   // 5-12% short
    : meterVal * (0.995 + Math.random() * 0.008); // Â±0.5% normal

  const duration = 8000;
  const startTime = Date.now();

  simInterval = setInterval(() => {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = progress < 0.5 ? 2*progress*progress : -1+(4-2*progress)*progress;

    sensorLitres = targetLitres * eased;
    flowRate = eased < 0.95
      ? (targetLitres / (duration / 60000)) * (1 - Math.abs(Math.sin(progress * Math.PI)) * 0.15)
      : 0;

    // Add noise
    const noiseFlow = flowRate + (Math.random() - 0.5) * 0.3;
    waveData.push(Math.max(0, noiseFlow));
    if (waveData.length > 80) waveData.shift();

    updateGauge(Math.max(0, noiseFlow));
    document.getElementById('sensorTotal').innerHTML = sensorLitres.toFixed(3) + '<span>L</span>';

    updateCompareBars(currentMeterReading, sensorLitres);
    updateDiff(currentMeterReading, sensorLitres, false);
    addStreamLine(sensorLitres, noiseFlow);

    if (progress >= 1) {
      clearInterval(simInterval);
      flowRate = 0;
      updateGauge(0);
    }
  }, 100);

  streamInterval = setInterval(() => {}, 500);
}

function stopSession() {
  clearInterval(simInterval);
  sessionActive = false;

  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
  document.getElementById('meterInput').disabled = false;
  document.getElementById('statusText').textContent = 'SENSOR READY';
  document.getElementById('statusDot').style.background = '#00ff88';

  const meter = currentMeterReading;
  const sensor = sensorLitres;
  const diff = Math.abs(meter - sensor);
  const fraud = diff > 0.15;

  updateGauge(0);
  waveData = Array(80).fill(0);

  sessionCount++;
  if (fraud) fraudCount++; else okCount++;
  document.getElementById('statTotal').textContent = sessionCount;
  document.getElementById('statFraud').textContent = fraudCount;
  document.getElementById('statOk').textContent = okCount;

  updateDiff(meter, sensor, true);
  addSessionLog(meter, sensor, diff, fraud);
  showReceipt(meter, sensor, diff, fraud);

  if (fraud) {
    showAlert('fraud', 'ğŸš¨', 'FRAUD DETECTED!',
      `Meter shows ${meter.toFixed(3)}L but sensor measured only ${sensor.toFixed(3)}L. Shortfall: ${diff.toFixed(3)}L`);
  } else {
    showAlert('ok', 'âœ…', 'Refueling Verified',
      `${sensor.toFixed(3)}L dispensed matches pump meter. Difference within safe threshold.`);
  }
}

function updateCompareBars(meter, sensor) {
  const maxVal = Math.max(meter, sensor, 0.01);
  const mPct = Math.min((meter / maxVal) * 100, 100);
  const sPct = Math.min((sensor / maxVal) * 100, 100);
  document.getElementById('barMeter').style.width = mPct + '%';
  document.getElementById('barSensor').style.width = sPct + '%';
  document.getElementById('barMeterVal').textContent = meter.toFixed(3);
  document.getElementById('barSensorVal').textContent = sensor.toFixed(3);
}

function updateDiff(meter, sensor, final) {
  const diff = Math.abs(meter - sensor);
  const fraud = diff > 0.15;
  const diffRow = document.getElementById('diffRow');
  document.getElementById('diffRowVal').textContent = diff.toFixed(3) + ' L';
  diffRow.className = 'diff-row ' + (final ? (fraud ? 'unsafe' : 'safe') : '');

  if (final) {
    document.getElementById('diffVal').textContent = diff.toFixed(3);
    document.getElementById('statusEmoji').textContent = fraud ? 'ğŸš¨' : 'âœ…';
    document.getElementById('statusMsg').textContent = fraud
      ? `âš ï¸ FRAUD ALERT â€” ${diff.toFixed(3)}L shortfall detected!`
      : `âœ… Verified â€” within safe threshold`;
    document.getElementById('statusMsg').style.color = fraud ? 'var(--danger)' : 'var(--accent2)';
  }
}

function addStreamLine(litres, flow) {
  const el = document.getElementById('dataStream');
  const ts = new Date().toISOString().substr(11,11);
  const line = document.createElement('div');
  line.textContent = `[${ts}] ESP32 â†’ flow:${flow.toFixed(3)} L/min | total:${litres.toFixed(4)} L`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
  if (el.children.length > 30) el.children[0].remove();
}

// â”€â”€ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addSessionLog(meter, sensor, diff, fraud) {
  const tbody = document.getElementById('logBody');
  const now = new Date();
  const id = 'SES-' + String(sessionCount).padStart(3,'0');
  const vehicle = document.getElementById('vehicleInput').value || 'UNKNOWN';

  if (tbody.children.length === 1 && tbody.children[0].cells.length === 1) tbody.innerHTML = '';

  sessionLogs.unshift({ id, time: now, vehicle, pump: selectedPump, fuel: selectedFuel, meter, sensor, diff, fraud });

  const row = document.createElement('tr');
  row.innerHTML = `
    <td class="mono" style="color:var(--muted)">${now.toLocaleTimeString()}</td>
    <td>${vehicle}</td>
    <td>${selectedPump}</td>
    <td>${selectedFuel}</td>
    <td class="mono">${meter.toFixed(3)}</td>
    <td class="mono" style="color:var(--accent2)">${sensor.toFixed(3)}</td>
    <td class="mono" style="color:${diff>0.15?'var(--danger)':diff>0.05?'var(--warn)':'var(--accent2)'}">${diff.toFixed(3)}</td>
    <td><span class="badge ${fraud?'badge-fraud':diff>0.05?'badge-warn':'badge-ok'}">${fraud?'FRAUD':diff>0.05?'WARNING':'VERIFIED'}</span></td>
    <td><button class="btn btn-outline" style="padding:5px 12px;font-size:11px" onclick="showLogReceipt(${sessionLogs.length-1})">ğŸ“„ Receipt</button></td>
  `;
  tbody.prepend(row);
}

// â”€â”€ Alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAlert(type, icon, title, msg) {
  const el = document.getElementById('alertBanner');
  el.className = 'alert-banner show ' + (type === 'fraud' ? 'fraud' : 'ok');
  document.getElementById('alertIcon').textContent = icon;
  document.getElementById('alertTitle').textContent = title;
  document.getElementById('alertMsg').textContent = msg;
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
function hideAlert() { document.getElementById('alertBanner').className = 'alert-banner'; }

// â”€â”€ Receipt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showReceipt(meter, sensor, diff, fraud) {
  const id = 'SES-' + String(sessionCount).padStart(3,'0');
  const now = new Date();
  document.getElementById('rSessionId').textContent = id;
  document.getElementById('rTime').textContent = now.toLocaleString();
  document.getElementById('rVehicle').textContent = document.getElementById('vehicleInput').value || 'UNKNOWN';
  document.getElementById('rPump').textContent = selectedPump;
  document.getElementById('rFuel').textContent = selectedFuel;
  document.getElementById('rMeter').textContent = meter.toFixed(3) + ' L';
  document.getElementById('rSensor').textContent = sensor.toFixed(3) + ' L';
  document.getElementById('rDiff').textContent = diff.toFixed(3) + ' L ' + (fraud ? 'âš ï¸' : 'âœ“');
  const statusEl = document.getElementById('rStatus');
  statusEl.textContent = fraud ? 'ğŸš¨ FRAUD DETECTED' : 'âœ… VERIFIED';
  statusEl.style.color = fraud ? 'var(--danger)' : 'var(--accent2)';
  document.getElementById('receiptModal').classList.add('show');
}
function showLogReceipt(idx) {
  const s = sessionLogs[idx];
  if (!s) return;
  const diff = Math.abs(s.meter - s.sensor);
  document.getElementById('rSessionId').textContent = s.id;
  document.getElementById('rTime').textContent = s.time.toLocaleString();
  document.getElementById('rVehicle').textContent = s.vehicle;
  document.getElementById('rPump').textContent = s.pump;
  document.getElementById('rFuel').textContent = s.fuel;
  document.getElementById('rMeter').textContent = s.meter.toFixed(3) + ' L';
  document.getElementById('rSensor').textContent = s.sensor.toFixed(3) + ' L';
  document.getElementById('rDiff').textContent = diff.toFixed(3) + ' L';
  const statusEl = document.getElementById('rStatus');
  statusEl.textContent = s.fraud ? 'ğŸš¨ FRAUD DETECTED' : 'âœ… VERIFIED';
  statusEl.style.color = s.fraud ? 'var(--danger)' : 'var(--accent2)';
  document.getElementById('receiptModal').classList.add('show');
}
function closeReceipt() { document.getElementById('receiptModal').classList.remove('show'); }
function printReceipt() { window.print(); }

// â”€â”€ Pump / Fuel selectors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectPump(el, name) {
  document.querySelectorAll('.pump-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedPump = name;
}
function selectFuel(el, name) {
  document.querySelectorAll('.fuel-chip').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedFuel = name;
}

// â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetAll() {
  clearInterval(simInterval);
  sessionActive = false;
  sensorLitres = 0;
  currentMeterReading = 0;
  flowRate = 0;
  waveData = Array(80).fill(0);

  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
  document.getElementById('meterInput').disabled = false;
  document.getElementById('meterInput').value = '';
  document.getElementById('sensorTotal').innerHTML = '0.000<span>L</span>';
  document.getElementById('meterDisplay').textContent = 'â€”';
  document.getElementById('diffVal').textContent = 'â€”';
  document.getElementById('statusEmoji').textContent = 'ğŸ”µ';
  document.getElementById('statusMsg').textContent = 'Start a session to begin verification';
  document.getElementById('statusMsg').style.color = 'var(--muted)';
  document.getElementById('barMeter').style.width = '0%';
  document.getElementById('barSensor').style.width = '0%';
  document.getElementById('barMeterVal').textContent = '0.000';
  document.getElementById('barSensorVal').textContent = '0.000';
  document.getElementById('diffRow').className = 'diff-row';
  document.getElementById('diffRowVal').textContent = 'â€”';
  document.getElementById('dataStream').innerHTML = '<div style="color:var(--muted)">Â» Session cleared. Awaiting data...</div>';
  document.getElementById('statusText').textContent = 'SENSOR READY';
  document.getElementById('sensorSub').textContent = 'No active session';
  updateGauge(0);
  hideAlert();
}

// Initial wave draw
drawWave();
</script>
</body>
</html>